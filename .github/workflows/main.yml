name: Android Build

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: FIX GRADLE WRAPPER (Important!)
      run: |
        # 1. پرانی فائلز ڈیلیٹ کریں
        rm -f gradle/wrapper/gradle-wrapper.jar 2>/dev/null || true
        
        # 2. نئی ڈائریکٹری بنائیں
        mkdir -p gradle/wrapper
        
        # 3. صحیح gradle-wrapper.properties بنائیں
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # 4. **اصل gradle-wrapper.jar ڈاؤن لوڈ کریں**
        echo "Downloading CORRECT gradle-wrapper.jar..."
        curl -L "https://repo.maven.apache.org/maven2/org/grails/grails-gradle-wrapper/8.2/grails-gradle-wrapper-8.2.jar" \
          -o gradle/wrapper/gradle-wrapper.jar
        
        # 5. چیک کریں کہ jar فائل ٹھیک ہے
        echo "Checking JAR file..."
        file gradle/wrapper/gradle-wrapper.jar
        ls -lh gradle/wrapper/gradle-wrapper.jar
        
        # 6. gradlew اسکرپٹ بنائیں
        cat > gradlew << 'EOF'
        #!/bin/bash
        
        # Resolve links
        PRG="$0"
        while [ -h "$PRG" ] ; do
            ls=`ls -ld "$PRG"`
            link=`expr "$ls" : '.*-> \(.*\)$'`
            if expr "$link" : '/.*' > /dev/null; then
                PRG="$link"
            else
                PRG=`dirname "$PRG"`"/$link"
            fi
        done
        
        SAVED="`pwd`"
        cd "`dirname \"$PRG\"`/" >/dev/null
        APP_HOME="`pwd -P`"
        cd "$SAVED" >/dev/null
        
        CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
        
        exec java -cp "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
        EOF
        
        chmod +x gradlew
        
        echo "✅ Gradle wrapper fixed!"
    
    - name: BUILD APK
      run: |
        ./gradlew clean
        ./gradlew assembleDebug --stacktrace --no-daemon
    
    - name: UPLOAD APK
      uses: actions/upload-artifact@v4
      with:
        name: urdu-keyboard
        path: app/build/outputs/apk/debug/*.apk
